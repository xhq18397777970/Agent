一、mcp 工具开发 CSDN教程：
https://blog.csdn.net/fufan_LLM/article/details/147333041?ops_request_misc=%257B%2522request%255Fid%2522%253A%25222a6915fe340ff93f69572cb97b67a491%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=2a6915fe340ff93f69572cb97b67a491&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-147333041-null-null.142^v102^pc_search_result_base5&utm_term=mcp%E5%B7%A5%E5%85%B7&spm=1018.2226.3001.4187


一、为什么代码设计是异步调用api，我直接执行函数得不到结果？
1、直接调用异步函数，不会执行函数体，网络请求也不会发出。
    （1）创建协程对象（只是一个待执行的任务容器），此时函数体未执行，网络请求也未发出
    （2）交给事件循环，此时才开始执行
    （3）返回响应后，事件循环恢复协程，从暂停点继续执行（格式化输出）最终得到返回值。
1、异步函数本质是“协程工厂”，涉及到协程、事件循环（调度器），直接调用只得到一个待执行的协程，并不会自己跑，需要交给时间循环托管，才能被真正调度。若设计的是同步客户端，虽代码设计简单，但无法应对大的并发（io等待期间会阻塞线程，cpu空转，而不是cpu让给其他任务执行，存在大量线程创建和销毁，开销大，且线程多系统容易崩溃）
2、异步流程：
    （1）将A、B、C都登记为待执行的协程任务
    （2）事件循环开始一起推进，A发起请求，立刻进入等待结果阶段，让出执行权，开始执行B、C
    （3）ABC都在执行，调度器无事可做，直到某个协程最先返回结果
    （4）
3、为何需要异步
    （1）网络IO存在请求延时，需要设计为异步。而不在于本地的CPU计算。
4、    result=asyncio(query_weather("beijing"))

二、function calling执行流程
1、用户提出问题后，模型不会立即返回结果，而是会根据用户的提问，检测是否需要调用外部工具，调用外部工具后，将执行结果和用户提问整合，回答
2、需要在提问时，将工具+user prompt一起输入给模型，模型才知道有哪些工具。工具不是通过message、system_prompt，而是通过tool（并且可选tool_choice让模型自己决定是否调用）
3、将工具信息给LLM，是否需要定义好功能、入参、返回值？
    （1）不需要返回值，只需要功能、入参，
    （2）虽然外部工具函数返回值模型都能理解，但未提高效果，会在Agent上，对返回值进行编排，比如json格式转为自然语言、其它json（剔除不要部分）

三、如何实现多轮对话
1、列表存储所有对话信息，包括：user_prompt、response、tool_calls、tool_return_content
2、每次对话会传入最近20条对话
# 用户输入
query = "杭州今天天气怎么样？"

# messages 状态：
messages = [
    {"role": "user", "content": "杭州今天天气怎么样？"}
]

# 调用 chat_base 后，messages 变为：
messages = [
    {"role": "user", "content": "杭州今天天气怎么样？"},
    {
        "role": "assistant", 
        "content": None,
        "tool_calls": [...]  # 包含工具调用信息
    },
    {
        "role": "tool",
        "content": "{\"temperature\": 24, \"condition\": \"晴朗\"}",
        "tool_call_id": "call_001"
    },
    {
        "role": "assistant",
        "content": "杭州今天天气晴朗，温度24℃，适合出行。"
    }
]

四、这个mcp服务，本质就是一个api接口调用的过程，那么mcp服务器建立连接的过程怎么理解？
1、当前mcp服务，是需要在本地执行python脚本，并在终端获得返回结果，因此需要进行stdio的传输，而stdio传输前必须要建立通道。本地进程+stdio建立长期JSON-RPC会话，而不是一次性HTTP API调用
2、
    （1）本地MCP
    （2）云端MCP：能力发现+JSON-RPC调用。

    结论：若只是纯HTTP 则无需对话/工具发现，但也失去了在同一次对话


五、当mcp server不可用时，是否会让LLM告知用户，”当前工具不可用“
1、目前：当重试用尽，抛出异常，不会把工具测错误作为tool信息反馈给大模型

六、天气查询接口只能传入英文参数，为了优化用户体验，如何、在哪个位置告诉模型工具的描述信息？
1、源头：工具函数docstring，客户端调用Server.list_tools()，mcp框架自动提取（函数名、提取整个docstring作为description、从函数签名生成inputSchema
2、原始MCP工具信息，转为Function calling格式
3、tools=[function_calling_tool,]传入大模型chat接口

七、将mcp server 发布到npm官方
    （1）生产环境（系统自动调用python执行，用户不需要知道背后细节）
    1、用户全局安装：npm install -g weather-server-xhq       无需考虑底层实现
    2、系统有个新的命令：mcp-server-git
    3、直接使用：mcp-server-git
    4、mcp-server-git --city "Beijing"
    5、bin字段，npm在全局安装时创建符号连接，使得脚本直接在命令行执行

    （2）开发环境： 使用uvx工具执行（某种python执行器）
    1、npm start     实际上执行uvx weather-server

    (3)发布流程：   
    1、创建node.js项目：npm init
    2、安装uvx工具，便于测试环境 执行：npm install uvx
    3、修改package.json  配置好bin、scripts、dependency、name（在npm官方库中唯一，要确保不与其它包名冲突
    4、测试环境，创建index.js 测试
    5、创建.npmignore文件（屏蔽不需要发布到npm的文件）
    6、npm login
    7、npm publish
    8、用户安装下载:npm install -g weather-server-xhq

八、我不太能理解为什么需要服务的管理，可以不要吗？因为大模型发起工具调用时，确实只需要发起http调用得到结果就可以了，为什么还需要这么多的服务启动，资源清理？
    1、http api 和mcp的本质区别：
        （1）mcp可以保持长连接、维护绘画状态，api无状态、无需管理连接
        （2）mcp：数据库操作（不需要频繁建立、关闭数据库连接）、网页爬虫（可以复用浏览器实例）

目前agent向mcp发起调用只是执行python脚本，发起http api请求，为什么还需要服务启动、资源清理的操作？
    1、mcp不是简单的http api调用，而是基于stdio通信的持久连接协议。
    2、每个mcp服务器是一个独立的python进程，通过subprocess.Popen启动。客户端通过stdio方式与服务器进程通信而不是http请求
    3、建立连接后，客户端与服务器端保持长期的双向通信与会话

    是否可以删掉管理？
    （1）（mcp基于进程通信，必须管理进程的生命周期
    （2）

    我有个问题，当前我如果希望将一个流程整合进行agent，有2个http接口，一个接口用于获取监控日志信息，一个接口用于对ip进行连接测试（ping）。我希望写这两个工具，并且完成一个任务，用户提出一个问题，“请你看看现在的监控数据，并且把所有内网ip，进行连接测试”。这个时候是否还需要所谓的stdio通信方式？是否还需要服务的连接管理、资源清理？因为http是无状态的只需要发起调用即可
